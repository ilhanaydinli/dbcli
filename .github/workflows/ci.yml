name: CI

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    quality:
        name: Lint & Type Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache dependencies
              if: ${{ !env.ACT }}
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Type check
              run: bun run check:types

            - name: Lint
              run: bun run check:lint

            - name: Format check
              run: bun run check:format

            - name: Unused code check
              run: bun run knip

    test:
        name: Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:17-alpine
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: testdb
                ports:
                    - 5433:5432
                options: >-
                    --health-cmd="pg_isready -U postgres"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install PostgreSQL client
              run: |
                  sudo apt-get update
                  sudo apt-get install -y postgresql-common
                  sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
                  sudo apt-get install -y postgresql-client-17

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Cache dependencies
              if: ${{ !env.ACT }}
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run tests
              run: bun test
